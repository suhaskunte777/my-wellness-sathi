# Wellness and Lead Management Application 

## Table of Contents
- [Wellness and Lead Management Application](#wellness-and-lead-management-application)
  - [Table of Contents](#table-of-contents)
  - [System Overview](#system-overview)
    - [Application Purpose](#application-purpose)
    - [Core Functionalities](#core-functionalities)
  - [Technology Stack](#technology-stack)
    - [Backend Framework](#backend-framework)
    - [Backend Development Tools](#backend-development-tools)
    - [Frontend Framework \& Packages](#frontend-framework--packages)
  - [User Authentication](#user-authentication)
  - [User Roles \& Permissions](#user-roles--permissions)
    - [Package for User and Access Management](#package-for-user-and-access-management)
    - [Primary Roles](#primary-roles)
    - [Access Control \& Permission Structure (RBAC + ABAC)](#access-control--permission-structure-rbac--abac)
  - [User and Related Migrations](#user-and-related-migrations)
    - [Core User Migration](#core-user-migration)
    - [Required Spatie Permission Migrations](#required-spatie-permission-migrations)
    - [Required Spatie Tags Migrations](#required-spatie-tags-migrations)
    - [Laravel Sanctum Migration](#laravel-sanctum-migration)
    - [Password Reset Migration](#password-reset-migration)
    - [Laravel Auditing Migration](#laravel-auditing-migration)
  - [Permission Definitions](#permission-definitions)
    - [Core Permissions](#core-permissions)
    - [Role-Permission Mappings](#role-permission-mappings)
  - [Security Considerations](#security-considerations)
    - [Password Policy](#password-policy)
    - [Token Management](#token-management)
    - [Rate Limiting](#rate-limiting)
    - [Audit Trail](#audit-trail)
  - [API Authentication Endpoints](#api-authentication-endpoints)
  - [Prospect and Related Migrations](#prospect-and-related-migrations)
  - [User and Prospect Shared Migritions](#user-and-prospect-shared-migritions)
    - [Profile Details](#profile-details)
    - [User Groups](#user-groups)
    - [Marketing Level](#marketing-level)
    - [Contacts](#contacts)
    - [Addresses](#addresses)
    - [Photos](#photos)
    - [Contacts](#contacts-1)
    - [Health](#health)

## System Overview

### Application Purpose
A comprehensive wellness industry platform serving four primary user types:
- **Coaches**: Wellness professionals who help others achieve health goals
- **Members**: Individuals progressing toward health goals
- **Mentors**: Primarily Coaches but also successful business leaders providing guidance
- **Guest**: Individuals who are prospect members of the organization, they are not registered yet so can't access any content. Those added by admin or coach will be called as Guest. Can be converted to member by admin or coach, once they take our product/program/service.

### Core Functionalities
- User Authentication and Authorization
- Prospect management and tracking 
- Member measurement and tracking
- Club Management and attendance
- Stock and inventory management
- Financial tracking and reporting
- Assessment, survey, TTP and Camp tools 
- Product/Service/Program/Batch management
- Marketing level management
- Communication and notification systems

## Technology Stack

- Backend is API only for application
- Also backend will have some UI for Horizon and Pulse
- Frontend will be Separate repository based on Quasar
- we will use uuid wherever data is getting generated by user, to facilitate offline creation of records.
- Models which only can create in online mode or not created by user can still continue using bigint id.
- SoftDelete all the tables, if excepting any table mention specifically why softDelete is not required their.
- Application should support dark mode (using Quasar)
- Use Quasar css classes for styling

### Backend Framework
- **Laravel 12** with PHP 8.4
- **MySQL 8.0+** for primary database
- **Redis** for caching and session management
- **Laravel Sanctum** for API authentication
- **Laravel Auditing** for audit trails
- **Spatie Laravel Permission** for RBAC
- **Spatie Laravel Tags** for tags ABAC
- **Laravel Backup** for data backup
- **Laravel Telescope** for debugging
- **Laravel Horizon** for queue management

### Backend Development Tools
- **Laravel Pail** for file storage
- **Laravel Pint** for code formatting
- **Larastan** for static analysis
- **PHPUnit** for testing

### Frontend Framework & Packages
- **Vue.js 4** 
- **Node.js 22**
- **PNPM** for package management
- **Quasar framework 2.18**
- **Vue router**
- **Pinia** Store Management
- **Axios** 
- **vcards-js**
- **dayjs**
- **html2pdf.js**
- **uuid** - for uuid generation

## User Authentication

- Use Token based authentication provided by *laravel/sanctum*
- User may have same email and mobile for multiple accounts
- We will use username (Unique across users) and password for authentication
- User belongs to family for viewing / switching other profiles
- Frontend should have quick profile switching support for authenticated user as Google provides for Gmail, Maps etc.
- For forget password, use username along with birth date and email.
- For forget username, use birth date, email, herbalife ID
- User only be created by invitation only

## User Roles & Permissions

### Package for User and Access Management
- Use *laravel/sanctum* for token based authentication (not cookie based)
- Use *spatie/laravel-permission* package for Role and Permission Management
- Use *spatie/laravel-tags* package for Tag Management

### Primary Roles
1. **Super Admin** - Full system access (Only one seeded by seeders)
2. **Admin** - Organization-level management (User is admin for his Organization. User will get manage organization feature after Active World Team. User org is members joined by him and his downline members)
3. **Mentor** - Business leadership and guidance (User is above GET marketing level is called as mentor)
4. **Coach** - Wellness coaching and member management (User in helping others to achieve their health goals is called as coach until they achieve GET marketing level)
5. **Member** - Personal wellness journey tracking (User is tracking their own wellness journey)
6. **Guest** - Limited access for assessments (User is not a member of the organization)

### Access Control & Permission Structure (RBAC + ABAC)

- Role Based Access Control
  - Used for Create, Update and Delete permission

- Attribute Based Access Control
  - Used for view can view given Model (data)
  - Tags will be used as attribute to control this behavior
  - User Groups will be assigned tags

## User and Related Migrations

### Core User Migration
```php
Schema::create('users', function (Blueprint $table) {
        $table->uuid('uuid')->primary();
        $table->string('name');
        $table->date('birth_date')->nullable();
        $table->string('business_id')->nullable();
        $table->boolean('business_owner')->default(0);
        $table->string('username')->unique();
        $table->string('email')->index();
        $table->timestamp('email_verified_at')->nullable();
        $table->string('mobile')->nullable();
        $table->timestamp('mobile_verified_at')->nullable();
        $table->string('password');
        $table->boolean('is_admin')->default(false);
        $table->foreign('created_by')->references('id')->on('users');
        $table->rememberToken();
        $table->timestamps();
        $table->softDeletes();
});
```

### Required Spatie Permission Migrations
 - We will use default tables from spatie/laravel-permission

### Required Spatie Tags Migrations
- Use spatie/laravel-tags default tags tables

### Laravel Sanctum Migration
```php
Schema::create('personal_access_tokens', function (Blueprint $table) {
    $table->id();
    $table->morphs('tokenable');
    $table->string('name');
    $table->string('type');
    $table->string('hash', 64)->unique();
    $table->text('abilities')->nullable();
    $table->timestamp('last_used_at')->nullable();
    $table->timestamp('expires_at')->nullable();
    $table->timestamps();
});
```

### Password Reset Migration
```php
Schema::create('password_reset_tokens', function (Blueprint $table) {
    $table->string('username')->primary();
    $table->string('token');
    $table->timestamp('created_at')->nullable();
});
```

### Laravel Auditing Migration
- We will use default migration from auditing package.

## Permission Definitions

### Core Permissions
```php
// User Management
'user.view', 'user.create', 'user.update', 'user.delete', 'user.invite'

// Role Management  
'role.view', 'role.create', 'role.update', 'role.delete', 'role.assign'

// Permission Management
'permission.view', 'permission.create', 'permission.update', 'permission.delete'

// Content Management
'content.view', 'content.create', 'content.update', 'content.delete'

// Assessment Management
'assessment.view', 'assessment.create', 'assessment.update', 'assessment.delete'

// Club Management
'club.view', 'club.create', 'club.update', 'club.delete', 'club.attend'

// Stock Management
'stock.view', 'stock.create', 'stock.update', 'stock.delete'

// Financial Management
'financial.view', 'financial.create', 'financial.update', 'financial.delete'

// Communication Management
'communication.view', 'communication.create', 'communication.update', 'communication.delete'
```

### Role-Permission Mappings
```php
// Super Admin - All permissions
'Super Admin' => ['*']

// Admin - Organization management
'Admin' => [
    'user.view', 'user.create', 'user.update', 'user.invite',
]

// Mentor - Business guidance
'Mentor' => [
    'user.view', 'user.invite',
]

// Coach - Member management
'Coach' => [
    'user.view', 'user.invite',
]

// Member - Personal tracking
'Member' => [
    'content.view',
]

// Guest - Limited access
'Guest' => [
    // 'assessment.view'
]
```

## Security Considerations

### Password Policy
- Minimum 8 characters
- Must contain uppercase, lowercase, number, and special character
- Password history: 3 previous passwords
- Password expiration: 90 days

### Token Management
- Access token expiration: 24 hours
- Refresh token expiration: 30 days
- Maximum active tokens per user: 3

### Rate Limiting
- Login attempts: 5 per 15 minutes
- API requests: 1000 per hour per user
- Password reset: 3 per hour per email

### Audit Trail
- All user actions logged
- Sensitive operations require additional verification
- Failed authentication attempts logged
- Token usage tracked

## API Authentication Endpoints

**Currently Implemented:**
```php
// Authentication Routes (Web-based, not API)
POST api/register  (invitation only)
POST api/login
POST api/logout
POST api/forgot-password
POST api/reset-password
GET api/verify-email/{id}/{hash}
POST api/email/verification-notification
```

**Planned API Endpoints:**
```php
// Authentication Routes

POST /api/auth/forgot-username
POST /api/auth/reset-password
POST /api/auth/verify-mobile

// Profile Management
GET /api/auth/profile
PUT /api/auth/profile
PUT /api/auth/password
POST /api/auth/profile-switch (for all authenticated profiles)
```

## Prospect and Related Migrations

```sql
Schema::create('prospects', function (Blueprint $table) {
    $table->uuid('uuid')->primary();
    $table->string('name');
    $table->string('primary_phone')->nullable();
    $table->date('birth_date')->nullable();
    $table->integer('birth_year', 4)->nullable();
    $table->integer('age')->nullable();
    $table->enum('age_by', ['birth_date', 'birth_year', 'age'])->nullable();
    $table->integer('height')->nullable();
    $table->enum('gender', ['male', 'female', 'other'])->nullable();
    $table->enum('marital_status', ['single', 'married', 'divorced', 'widowed'])->nullable();
    $table->enum('occupation', ['student', 'employed', 'unemployed', 'retired', 'housewife', 'other'])->nullable();
    $table->string('mother_tongue', 25)->nullable();
    $table->enum('source', ['TTP', 'Assessment', 'Measurement_Camp', 'Referral', 'Paper_Insert', 'Circular_of_Influence', 'Social_Media', 'Advertisement', 'Walk_In', 'Other'])->nullable();
    $table->string('source_details', 191)->nullable();
    $table->enum('lead_stage', ['New', 'Contacted', 'Interested', 'Qualified', 'Converted', 'Lost', 'Hold', 'Archived'])->nullable();
    $table->string('referred_by', 36)->nullable();
    $table->string('notes')->nullable();
    $table->date('last_follow_up_date')->nullable();
    $table->date('next_follow_up_date')->nullable();

    $table->string('health_challenge', 255)->nullable();
    $table->string('medication', 255)->nullable();
    $table->string('health_goal', 255)->nullable();
    
    $table->integer('conversion_probability')->nullable();
    $table->string('converted_to_user_id', 36)->nullable();
    $table->timestamp('converted_at')->nullable();
    $table->boolean('is_active')->default(true);

    $table->foreignUuid('created_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
    $table->foreignUuid('updated_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
    $table->foreignUuid('deleted_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
    $table->foreignUuid('coach_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');

    $table->timestamps();
    $table->softDeletes();
    
    // Performance indexes
    $table->index(['lead_stage', 'is_active']);
    $table->index(['coach_id', 'is_active']);
    $table->index(['created_by', 'is_active']);
    $table->index(['next_follow_up_date']);
    $table->index(['converted_to_user_id']);
});
```


## User and Prospect Shared Migritions

### Profile Details
```php
    Schema::create('profile_details', function (Blueprint $table) {
        $table->uuid('uuid')->primary();
        $table->foreignUuid('user_id')->constrained('users', 'uuid')->onDelete('cascade');
        $table->string('first_name', 191)->nullable();
        $table->string('middle_name', 191)->nullable();
        $table->string('last_name', 191)->nullable();
        $table->string('primary_email', 50)->nullable();
        $table->string('primary_phone', 18)->nullable();
        $table->date('birth_date')->nullable();
        $table->integer('birth_year', 4)->nullable();
        $table->integer('age', 3)->nullable();
        $table->enum('age_by', ['birth_date', 'birth_year', 'age'])->nullable();
        $table->enum('gender', ['male', 'female', 'other'])->nullable();
        $table->enum('marital_status', ['single', 'married', 'divorced', 'widowed'])->nullable();
        $table->enum('source', ['TTP', 'Assessment', 'Measurement_Camp', 'Referral', 'Paper_Insert', 'Circular_of_Influence', 'Social_Media', 'Advertisement', 'Walk_In', 'Other'])->nullable();
        $table->string('source_details', 191)->nullable();
        $table->string('occupation', 191)->nullable();
        $table->string('mother_tongue', 25)->nullable();
        $table->string('notes')->nullable();
        $table->date('last_follow_up_date')->nullable();
        $table->date('next_follow_up_date')->nullable();
        $table->string('converted_from_prospect_uuid', 36)->nullable();
        $table->timestamp('converted_at')->nullable();
        
        $table->enum('marketing_level', ['Guest', 'Preferred_Customer', 'Associate', 'Senior_Consultant', 'Success_Builder', 'Supervisor', 'Active_Supervisor', 'World_Team', 'Active_World_Team', 'GET', 'GET 2500','MIL', 'MIL 7500', 'PRESIDENT TEAM', 'Executive Presidents Team', 'Senior Executive Presidents Team', 'International Executive Presidents Team', 'Chief Executive Presidents Team', 'Chairmans Club', 'Founder Circle' ])->default('Guest');
        $table->integer('diamonds')->nullable();
        $table->integer('stones')->nullable();
        $table->integer('royalty_level')->nullable();
        $table->integer('discount_level')->default(0);
        $table->integer('years_active')->default(0);
        $table->integer('mark_hughes_award')->default(0);

        $table->string('supervisor_id', 36)->nullable(); // First upline supervisor marketing level
        $table->string('world_team_id', 36)->nullable(); // First upline world team marketing level
        $table->string('get_id', 36)->nullable(); // First upline get marketing level
        $table->string('mil_id', 36)->nullable(); // First upline mil marketing level
        $table->string('president_team_id', 36)->nullable(); // First upline president team marketing level
        
        $table->boolean('is_active')->default(true);
        $table->foreignUuid('coach_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('referred_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('supervisor_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('world_team_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('get_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('mil_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('president_team_id')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('created_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('updated_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('deleted_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        
        $table->timestamps();
        $table->softDeletes();
        
        // Performance indexes
        $table->index(['user_id', 'is_active']);
        $table->index(['coach_id', 'is_active']);
        $table->index(['created_by', 'is_active']);
        $table->index(['next_follow_up_date']);
        $table->index(['converted_from_prospect_uuid']);
    });
```

### User Groups

```php
    Schema::create('groups', function (Blueprint $table) {
        $table->uuid('uuid')->primary();
        $table->string('groupable_type', 191)->nullable(); // User or Club or Prospect
        $table->string('groupable_id', 36)->nullable(); // User or Club or Prospect ID
        $table->string('name')->notNull();
        $table->string('description')->nullable();
        $table->enum('type', ['marketing_level', 'coach_hierarchy', 'club', 'non-supervisor', 'batch', 'demographic', 'program_batch', 'custom'])->notNull();
        $table->string('custom_type')->nullable();
        $table->string('group_code')->nullable()->unique();
        $table->json('criteria')->nullable();
        $table->boolean('auto_assign')->default(false);
        $table->boolean('is_active')->default(true);
        $table->foreignUuid('created_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('updated_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('deleted_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->timestamps();
        $table->softDeletes();
        
        // Performance indexes
        $table->index(['groupable_type', 'groupable_id']);
        $table->index(['type', 'is_active']);
        $table->index(['created_by', 'is_active']);
});
```

- **User Auto assing Groups Criteria**
  - marketing_level
    - Based on marketing level, assing the group to the user.
  - club
    - Based on club, assing the group to the user.
  - All non-supervisor users
    - Users belogns to 'Associate', 'Senior_Consultant', 'Success_Builder' marketing level are called as non-supervisor.
  - All supervisor users
    - Users belogns to 'Supervisor' and above marketing level are called as supervisor.
  - All TAB team users all 
    - Users belogns to GET and above till MIL7500 marketing level are called as TAB team.
  - All President team users
    - Users belogns to 'President Team', 'Executive Presidents Team', 'Senior Executive Presidents Team', 'International Executive Presidents Team', 'Chief Executive Presidents Team', 'Chairmans Club', 'Founder Circle' marketing level are called as President team.


### Marketing Level 

- This is a fix value table, feel with seeding only. And can be keep long cached.
```php
Schema::create('marketing_levels', function (Blueprint $table) {
    $table->id();
    $table->integer('level')->unique();
    $table->string('name')->index();
    $table->timestamps();
});
```


### Contacts

- All contacts with country code, email format, phone format, etc. should be validated during input. if not available in laravel inbuilt, then use its ecosystem or third party package.

```php
    Schema::create('contacts', function (Blueprint $table) {
        $table->uuid('uuid')->primary();
        $table->string('contactable_type', 191)->nullable(); // User or Club
        $table->string('contactable_id', 36)->nullable(); // User or Club ID
        $table->enum('type', ['Mobile', 'TelePhone', 'WhatsApp', 'Email', 'Facebook', 'Instagram', 'YouTube', 'Telegram', 'Other', 'WhatsApp Business', 'WhatsApp Personal', 'Custom'])->default('Mobile');
        $table->string('custom_type')->nullable();
        $table->string('value')->notNull();
        $table->boolean('is_primary')->default(false);
        $table->boolean('is_verified')->default(false);
        $table->string('tags')->nullable();
        $table->foreignUuid('created_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('updated_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('deleted_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->timestamps();
        $table->softDeletes();
        
        // Performance indexes
        $table->index(['contactable_type', 'contactable_id']);
        $table->index(['type', 'is_primary']);
        $table->index(['is_verified']);
    });
```

### Addresses

- As we dont have all city, taluka, district, state, country, pincode in our system, we need to use any third party service to get this verified or also strip, capitalization, etc. during input validation. check if laravel or its ecosystem or third party has any package for this.
- If google map link is provided, then can we get latitude and longitude from it without any cost? if yes, then we can use it.
- Also can we get city, taluka, district, state, country, pincode from google map link without any cost? if yes, then we can use it.

```php  
    Schema::create('addresses', function (Blueprint $table) {
        $table->uuid('uuid')->primary();
        $table->string('addressable_type', 191)->nullable(); // User or Club
        $table->string('addressable_id', 36)->nullable(); // User or Club ID
        $table->enum('type', ['home', 'office', 'club', 'temporary', 'other', 'custom'])->default('home');
        $table->string('address_name')->nullable();
        $table->string('address_line_1')->notNull();
        $table->string('address_line_2')->nullable();
        $table->string('city')->notNull();
        $table->string('taluka')->nullable();
        $table->string('district')->notNull();
        $table->string('state')->notNull();
        $table->string('country')->notNull()->default('India');
        $table->string('pincode')->notNull();
        $table->string('google_map_link')->nullable();
        $table->decimal('latitude', 11, 8)->nullable();
        $table->decimal('longitude', 11, 8)->nullable();
        $table->boolean('is_primary')->default(false);
        $table->foreignUuid('created_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('updated_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->foreignUuid('deleted_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
        $table->timestamps();
        $table->softDeletes();
        
        // Performance indexes
        $table->index(['addressable_type', 'addressable_id']);
        $table->index(['type', 'is_primary']);
        $table->index(['city', 'state']);
        $table->index(['pincode']);
        $table->index(['latitude', 'longitude']);
    });
```

### Photos

- All photos should be stored in storage/app/public/photos/user_photos/
- We should have a library or package to compress the photo before storing in database without losing quality.
- photos should have expiry date, after which it will be deleted from database and storage.
- frontend we can use some library to identify the photo type and suggest it accordingly.

```php 
Schema::create('photos', function (Blueprint $table) {
    $table->uuid('uuid')->primary();
    $table->string('photoable_type', 191)->nullable(); // User or Club or Prospect
    $table->string('photoable_id', 36)->nullable(); // User or Club or Prospect ID
    $table->enum('type', ['Profile', 'Front', 'Back', 'Left', 'Right', 'Full_body', 'Measurement', 'Shake', 'Afresh', 'Skin_Booster', 'H24_Hydrate', 'H24_Rebuild', 'Sleep_Enhancer', 'Niteworks', 'Beta_Heart', 'Tablet',  'Meal', 'Snacks', 'Activity_Proof', 'Custom'])->notNull();
    $table->string('custom_type')->nullable();
    $table->string('file_path', 500)->notNull();
    $table->string('file_name', 255)->notNull();
    $table->integer('file_size')->notNull();
    $table->string('mime_type', 100)->notNull();
    $table->string('caption')->nullable();
    $table->timestamp('taken_at')->nullable();
    $table->decimal('latitude', 10, 8)->nullable();
    $table->decimal('longitude', 11, 8)->nullable();
    $table->boolean('is_primary')->default(false);
    $table->string('tags')->nullable();
    $table->foreignUuid('created_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
    $table->foreignUuid('updated_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
    $table->foreignUuid('deleted_by')->nullable()->constrained('users', 'uuid')->onDelete('cascade');
    $table->timestamps();
    $table->softDeletes();
    
    // Performance indexes
    $table->index(['photoable_type', 'photoable_id']);
    $table->index(['type', 'is_primary']);
    $table->index(['file_path']);
    $table->index(['taken_at']);
    $table->index(['latitude', 'longitude']);
});
```


### Contacts


### Health

